<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIDD SPORTS</title>
    <!-- Link to the Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme color for the browser address bar -->
    <meta name="theme-color" content="#4f46e5">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js" onload="window.pdfLibrariesLoaded = true;"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Apply dark mode immediately to prevent flash of light mode
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .modal:not([open]) {
            pointer-events: none;
            opacity: 0;
        }
        .modal:not([open]) .modal-content {
            transform: scale(0.95);
        }
        .loader {
            border-top-color: #4f46e5; /* indigo-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 dark:bg-slate-900 dark:text-slate-200">

    <!-- 
      Tailwind CSS Safelist:
      This hidden block contains all the dynamically generated color classes for the house themes.
      It ensures that Tailwind's JIT compiler includes these styles in the final CSS.
    -->
    <div class="hidden">
        <span class="bg-yellow-200 text-yellow-800 border-yellow-400"></span>
        <span class="bg-green-200 text-green-800 border-green-400"></span>
        <span class="bg-red-200 text-red-800 border-red-400"></span>
        <span class="bg-blue-200 text-blue-800 border-blue-400"></span>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- Header -->
        <header class="flex items-center justify-between gap-4 md:gap-6 mb-6 md:mb-8">
            <div class="flex items-center gap-4 md:gap-6">
                 <div class="p-2 bg-white rounded-lg shadow-md">
                    <img id="schoolLogo" src="HurunuiCollegeLogoRefresh-07%20large.png" alt="School Logo" class="w-20 h-20 md:w-24 md:h-24 object-contain">
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white">BIDD SPORTS</h1>
                    <p class="text-slate-600 dark:text-slate-400 mt-1">Your official tool for managing sports competitions.</p>
                </div>
            </div>
            <!-- Dark Mode Toggle -->
            <label for="theme-toggle" class="inline-flex relative items-center cursor-pointer">
                <input type="checkbox" value="" id="theme-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">Dark Mode</span>
            </label>
        </header>

        <!-- Loading State -->
        <div id="loading" class="flex flex-col justify-center items-center py-20">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <p id="loading-message" class="mt-4 text-slate-600 dark:text-slate-400 text-center">Connecting to database...</p>
        </div>
        
        <!-- Main Content (Hidden until loaded) -->
        <main id="mainContent" class="hidden">

             <!-- Meets View -->
            <div id="meetsView">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-200">Competitions</h2>
                    <button id="addMeetBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition duration-200">
                        + Add Competition
                    </button>
                </div>
                 <p class="text-slate-500 dark:text-slate-400 mb-4 -mt-2">Select a competition to view its events or create a new one.</p>
                <div id="meetsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Meet cards will be inserted here -->
                </div>
                 <div id="noMeetsMessage" class="hidden text-center py-16 bg-white dark:bg-slate-800 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-slate-700 dark:text-slate-300">No competitions yet!</h3>
                    <p class="text-slate-500 dark:text-slate-400 mt-2">Click the "+ Add Competition" button to get started.</p>
                </div>
            </div>
            
            <!-- Events View -->
            <div id="eventsView" class="hidden">
                 <div class="mb-4">
                     <button id="backToMeetsBtn" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium transition duration-200">
                        &larr; Back to Competitions
                    </button>
                </div>
                <div id="housePointsContainer" class="mb-8 bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 id="housePointsTitle" class="text-2xl font-semibold text-slate-800 dark:text-slate-200">Team Points</h2>
                        <button id="printHousePointsBtn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Loading...
                        </button>
                    </div>
                     <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Placing: 1st (5), 2nd (3), 3rd (1). Participation: 1 point per participant with a result or checkbox ticked.</p>
                    <ol id="housePointsList" class="space-y-3">
                        <!-- House points will be dynamically inserted here -->
                    </ol>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 id="eventsTitle" class="text-2xl font-semibold text-slate-800 dark:text-slate-200">Events</h2>
                    <div class="flex gap-2">
                         <button id="shareLinkBtn" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition duration-200">
                            Share Sign-up Link
                        </button>
                        <button id="addEventBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition duration-200">
                            + Add Event
                        </button>
                    </div>
                </div>
                 <p class="text-slate-500 dark:text-slate-400 mb-4 -mt-2">Click on an event to view results, or add a new event for this competition.</p>
                <div id="eventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Event cards will be inserted here -->
                </div>
                 <div id="noEventsMessage" class="hidden text-center py-16 bg-white dark:bg-slate-800 rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-slate-700 dark:text-slate-300">No events yet!</h3>
                    <p class="text-slate-500 dark:text-slate-400 mt-2">Click the "+ Add Event" button to get started.</p>
                </div>
            </div>

            <!-- Results View (Initially hidden) -->
            <div id="resultsView" class="hidden">
                <div class="mb-4">
                     <button id="backToEventsBtn" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium transition duration-200">
                        &larr; Back to Events
                    </button>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <div>
                            <h2 id="resultsEventName" class="text-3xl font-bold text-slate-900 dark:text-white"></h2>
                            <p id="resultsEventInfo" class="text-slate-500 dark:text-slate-400"></p>
                        </div>
                        <div class="flex gap-2 flex-wrap justify-end">
                             <button id="printResultsBtn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                Loading...
                            </button>
                            <input type="file" id="csvFileInput" class="hidden" accept=".csv">
                            <button id="uploadCsvBtn" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition duration-200">
                                Upload CSV
                            </button>
                            <button id="addParticipantBtn" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-teal-700 transition duration-200">
                                + Add Participant
                            </button>
                        </div>
                    </div>
                     <p class="text-slate-500 dark:text-slate-400 mb-4 -mt-2">Add participants manually or upload a CSV. Click actions to add/edit results or participant details.</p>
                    <div id="resultsContainer" class="overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600">
                                <tr>
                                    <th class="p-3 font-semibold text-sm text-slate-600 dark:text-slate-300">Placing</th>
                                    <th class="p-3 font-semibold text-sm">
                                        <button id="sortByNameBtn" class="flex items-center gap-1 text-slate-600 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                                            Participant Name
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                              <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 12l-4-4m4 4l4-4m6-4v12m0-12l4 4m-4-4l-4 4" />
                                            </svg>
                                        </button>
                                    </th>
                                    <th class="p-3 font-semibold text-sm text-slate-600 dark:text-slate-300">Team/House</th>
                                    <th class="p-3 font-semibold text-sm text-slate-600 dark:text-slate-300">Participated</th>
                                    <th class="p-3 font-semibold text-sm text-slate-600 dark:text-slate-300">Result</th>
                                    <th class="p-3 font-semibold text-sm text-slate-600 dark:text-slate-300">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Results will be inserted here -->
                            </tbody>
                        </table>
                        <div id="noParticipantsMessage" class="hidden text-center py-12">
                            <p class="text-slate-500 dark:text-slate-400">No participants have been added to this event yet.</p>
                        </div>
                    </div>
                </div>
                 <div class="mt-6 flex justify-end">
                        <button id="deleteEventBtn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-red-700 transition duration-200">
                           Delete Event
                        </button>
                    </div>
            </div>
            
        </main>
        
        <!-- Public Sign-up View -->
        <div id="signupView" class="hidden">
            <h2 id="signupCompetitionName" class="text-3xl font-bold text-slate-900 dark:text-white mb-2"></h2>
            <p class="text-slate-500 dark:text-slate-400 mb-6">Select an event to sign up for.</p>
            <div id="signupEventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Sign-up event cards will be inserted here -->
            </div>
             <div id="noSignupEventsMessage" class="hidden text-center py-16 bg-white dark:bg-slate-800 rounded-lg shadow-sm">
                <h3 class="text-xl font-medium text-slate-700 dark:text-slate-300">No events available for sign-up.</h3>
                <p class="text-slate-500 dark:text-slate-400 mt-2">Please check back later or contact the event organizer.</p>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <dialog id="addMeetModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Add New Competition</h3>
            <form id="addMeetForm">
                <div class="mb-6">
                    <label for="meetName" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Competition Name</label>
                    <input type="text" id="meetName" name="meetName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" placeholder="e.g., Annual Sports Day 2025" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Create Competition</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="addEventModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Add New Event</h3>
            <form id="addEventForm">
                <div class="mb-4">
                    <label for="eventName" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Event Name</label>
                    <input type="text" id="eventName" name="eventName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" placeholder="e.g., 100m Sprint" required>
                </div>
                <div class="mb-4">
                    <label for="scoringMethod" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Scoring Method</label>
                    <select id="scoringMethod" name="scoringMethod" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                        <option value="low-wins">Lowest score wins (e.g., time)</option>
                        <option value="high-wins">Highest score wins (e.g., points)</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="eventUnits" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Units</label>
                    <input type="text" id="eventUnits" name="eventUnits" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" placeholder="e.g., s, m, points" required>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="col-span-1">
                        <label for="eventRecord" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Record</label>
                        <input type="number" step="any" id="eventRecord" name="eventRecord" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm">
                    </div>
                    <div class="col-span-2">
                        <label for="recordHolder" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Record Holder</label>
                        <input type="text" id="recordHolder" name="recordHolder" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm">
                    </div>
                    <div class="col-span-1">
                         <label for="recordYear" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Year</label>
                        <input type="number" id="recordYear" name="recordYear" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm">
                    </div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Create Event</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="addParticipantModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Add Participant</h3>
            <form id="addParticipantForm">
                <div class="mb-4">
                    <label for="athleteName" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Participant Name</label>
                    <input type="text" id="athleteName" name="athleteName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="mb-6">
                    <label for="houseGroup" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Team / House</label>
                    <select id="houseGroup" name="houseGroup" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                        <option value="Mason">Mason</option>
                        <option value="Sheppard">Sheppard</option>
                        <option value="Sumner">Sumner</option>
                        <option value="Taylor">Taylor</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                    <button type="submit" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition">Add Participant</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="editParticipantModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Edit Participant</h3>
            <form id="editParticipantForm">
                <input type="hidden" id="editParticipantId" name="participantId">
                <div class="mb-4">
                    <label for="editAthleteName" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Participant Name</label>
                    <input type="text" id="editAthleteName" name="athleteName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="mb-6">
                    <label for="editHouseGroup" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Team / House</label>
                    <select id="editHouseGroup" name="houseGroup" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                        <option value="Mason">Mason</option>
                        <option value="Sheppard">Sheppard</option>
                        <option value="Sumner">Sumner</option>
                        <option value="Taylor">Taylor</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <dialog id="editResultModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Enter Result</h3>
            <p class="mb-4 dark:text-slate-300">Entering result for <strong id="editResultAthleteName" class="dark:text-white"></strong>.</p>
            <form id="editResultForm">
                <input type="hidden" id="editResultParticipantId" name="participantId">
                <div class="mb-6">
                    <label for="resultValue" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Result</label>
                    <input type="number" step="any" id="resultValue" name="resultValue" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Result</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="csvUploadModal" class="modal p-0 rounded-lg shadow-xl max-w-2xl w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Import Participants from CSV</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-4">Map the columns from your CSV file to the required fields.</p>
            <div id="csvMapping" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="csvFirstName" class="block text-sm font-medium text-slate-700 dark:text-slate-300">First Name Column</label>
                    <select id="csvFirstName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm"></select>
                </div>
                <div>
                    <label for="csvSurname" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Surname Column</label>
                    <select id="csvSurname" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm"></select>
                </div>
                <div>
                    <label for="csvHouseGroup" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Team / House Column</label>
                    <select id="csvHouseGroup" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm"></select>
                </div>
            </div>
            <p class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Data Preview (first 5 rows)</p>
            <div class="overflow-x-auto border rounded-lg dark:border-slate-600">
                <table class="w-full text-left">
                    <thead id="csvPreviewHead" class="bg-slate-50 dark:bg-slate-700"></thead>
                    <tbody id="csvPreviewBody"></tbody>
                </table>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                <button type="button" id="confirmCsvImport" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Confirm & Import</button>
            </div>
        </div>
    </dialog>

    <dialog id="deleteConfirmModal" class="modal p-0 rounded-lg shadow-xl max-w-sm w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-2 dark:text-white">Are you sure?</h3>
            <p id="deleteConfirmText" class="text-slate-600 dark:text-slate-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </dialog>
    
    <dialog id="shareLinkModal" class="modal p-0 rounded-lg shadow-xl max-w-lg w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4 dark:text-white">Share Sign-up Link</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-4">Share this link with participants to allow them to sign up for events in this competition.</p>
            <input type="text" id="shareableLink" readonly class="w-full p-2 border rounded-md bg-slate-100 dark:bg-slate-700 dark:text-white dark:border-slate-600">
            <div class="flex justify-end gap-3 mt-4">
                <button id="copyLinkBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Copy Link</button>
                <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Close</button>
            </div>
        </div>
    </dialog>

     <dialog id="publicSignupModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white dark:bg-slate-800 p-6 rounded-lg">
            <div id="signupFormContainer">
                <h3 id="signupEventName" class="text-xl font-bold mb-4 dark:text-white">Sign Up</h3>
                <form id="publicSignupForm">
                    <input type="hidden" id="signupEventId" name="eventId">
                    <div class="mb-4">
                        <label for="signupName" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Full Name</label>
                        <input type="text" id="signupName" name="signupName" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                    </div>
                    <div class="mb-6">
                        <label for="signupHouse" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Team / House</label>
                        <select id="signupHouse" name="signupHouse" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 dark:text-white border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm" required>
                            <option value="Mason">Mason</option>
                            <option value="Sheppard">Sheppard</option>
                            <option value="Sumner">Sumner</option>
                            <option value="Taylor">Taylor</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" class="cancel-btn bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button>
                        <button type="submit" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition">Sign Up</button>
                    </div>
                </form>
            </div>
             <div id="signupMessageContainer" class="hidden text-center">
                <p id="signupMessage" class="text-lg font-medium text-slate-800 dark:text-slate-200"></p>
                <button type="button" class="cancel-btn mt-4 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Close</button>
            </div>
        </div>
    </dialog>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc,
            updateDoc,
            onSnapshot,
            query,
            deleteDoc,
            writeBatch,
            getDocs,
            where,
            enableIndexedDbPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =====================================================================================
        // ======================== IMPORTANT FIREBASE SETUP ===================================
        // =====================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA2BPCoA6qWKYLXBfpjhzvaTn4HyC03sE4",
            authDomain: "bidd-sports.firebaseapp.com",
            projectId: "bidd-sports",
            storageBucket: "bidd-sports.appspot.com",
            messagingSenderId: "863210699877",
            appId: "1:863210699877:web:84d08bb519ae1aeb7eda8c"
        };
        const appId = "bidd-sports";
        // =====================================================================================
        // ======================== END OF SETUP SECTION =======================================
        // =====================================================================================

        let app, auth, db;
        let userId;
        let currentMeetId = null;
        let currentEventId = null;
        let currentMeetName = '';
        let currentEventName = '';
        let currentEvent = null;
        let currentParticipants = [];
        let currentSortOrder = 'placing'; // 'placing' or 'alphabetical'

        let meetsUnsubscribe = null;
        let eventsUnsubscribe = null;
        let resultsUnsubscribe = null;
        let parsedCsvData = null;
        
        const houseColors = {
            'Mason': { bg: 'bg-yellow-200', text: 'text-yellow-800', border: 'border-yellow-400' },
            'Sheppard': { bg: 'bg-green-200', text: 'text-green-800', border: 'border-green-400' },
            'Sumner': { bg: 'bg-red-200', text: 'text-red-800', border: 'border-red-400' },
            'Taylor': { bg: 'bg-blue-200', text: 'text-blue-800', border: 'border-blue-400' }
        };
        
        const loadingEl = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const mainContentEl = document.getElementById('mainContent');
        
        const meetsView = document.getElementById('meetsView');
        const meetsGrid = document.getElementById('meetsGrid');
        const noMeetsMessage = document.getElementById('noMeetsMessage');
        const addMeetBtn = document.getElementById('addMeetBtn');
        const addMeetModal = document.getElementById('addMeetModal');
        const addMeetForm = document.getElementById('addMeetForm');

        const eventsView = document.getElementById('eventsView');
        const eventsGrid = document.getElementById('eventsGrid');
        const noEventsMessage = document.getElementById('noEventsMessage');
        const backToMeetsBtn = document.getElementById('backToMeetsBtn');
        const addEventBtn = document.getElementById('addEventBtn');
        const addEventModal = document.getElementById('addEventModal');
        const addEventForm = document.getElementById('addEventForm');
        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const shareLinkModal = document.getElementById('shareLinkModal');
        const shareableLinkInput = document.getElementById('shareableLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');

        const signupView = document.getElementById('signupView');
        const signupCompetitionName = document.getElementById('signupCompetitionName');
        const signupEventsGrid = document.getElementById('signupEventsGrid');
        const noSignupEventsMessage = document.getElementById('noSignupEventsMessage');
        const publicSignupModal = document.getElementById('publicSignupModal');
        const publicSignupForm = document.getElementById('publicSignupForm');
        const signupEventName = document.getElementById('signupEventName');
        const signupEventIdInput = document.getElementById('signupEventId');
        const signupFormContainer = document.getElementById('signupFormContainer');
        const signupMessageContainer = document.getElementById('signupMessageContainer');
        const signupMessage = document.getElementById('signupMessage');


        const resultsView = document.getElementById('resultsView');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsEventName = document.getElementById('resultsEventName');
        const resultsEventInfo = document.getElementById('resultsEventInfo');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noParticipantsMessage = document.getElementById('noParticipantsMessage');
        const backToEventsBtn = document.getElementById('backToEventsBtn');
        const addParticipantBtn = document.getElementById('addParticipantBtn');
        const addParticipantModal = document.getElementById('addParticipantModal');
        const addParticipantForm = document.getElementById('addParticipantForm');
        
        const editParticipantModal = document.getElementById('editParticipantModal');
        const editParticipantForm = document.getElementById('editParticipantForm');
        const editParticipantIdInput = document.getElementById('editParticipantId');
        const editAthleteNameInput = document.getElementById('editAthleteName');
        const editHouseGroupSelect = document.getElementById('editHouseGroup');

        const editResultModal = document.getElementById('editResultModal');
        const editResultForm = document.getElementById('editResultForm');
        const editResultAthleteName = document.getElementById('editResultAthleteName');
        const editResultParticipantId = document.getElementById('editResultParticipantId');

        const deleteEventBtn = document.getElementById('deleteEventBtn');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const deleteConfirmText = document.getElementById('deleteConfirmText');

        const uploadCsvBtn = document.getElementById('uploadCsvBtn');
        const csvFileInput = document.getElementById('csvFileInput');
        const csvUploadModal = document.getElementById('csvUploadModal');
        const confirmCsvImport = document.getElementById('confirmCsvImport');
        const csvFirstNameSelect = document.getElementById('csvFirstName');
        const csvSurnameSelect = document.getElementById('csvSurname');
        const csvHouseGroupSelect = document.getElementById('csvHouseGroup');
        const csvPreviewHead = document.getElementById('csvPreviewHead');
        const csvPreviewBody = document.getElementById('csvPreviewBody');
        const housePointsList = document.getElementById('housePointsList');
        const housePointsTitle = document.getElementById('housePointsTitle');
        const eventsTitle = document.getElementById('eventsTitle');
        const printHousePointsBtn = document.getElementById('printHousePointsBtn');
        const printResultsBtn = document.getElementById('printResultsBtn');
        const sortByNameBtn = document.getElementById('sortByNameBtn');
        const themeToggle = document.getElementById('theme-toggle');

        function showView(view) {
            meetsView.classList.toggle('hidden', view !== 'meets');
            eventsView.classList.toggle('hidden', view !== 'events');
            resultsView.classList.toggle('hidden', view !== 'results');
            signupView.classList.add('hidden'); // Always hide admin views when showing public
        }
        function formatTime(seconds) {
            if (seconds === null || seconds === undefined || isNaN(seconds)) return 'N/A';
            const totalSeconds = parseFloat(seconds);
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            const paddedMins = String(mins).padStart(2, '0');
            const paddedSecs = secs.toFixed(2).padStart(5, '0');
            return `${paddedMins}:${paddedSecs}`;
        }

        function isTimeBased(type) {
            return type === 'low-wins';
        }

        // --- MEET FUNCTIONS ---
        function renderMeets(meets) {
            meetsGrid.innerHTML = '';
            noMeetsMessage.classList.toggle('hidden', meets.length > 0);
            meets.forEach(meet => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-slate-800 p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer';
                card.innerHTML = `<h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 truncate">${meet.name}</h3>`;
                card.addEventListener('click', () => {
                    currentMeetId = meet.id;
                    currentMeetName = meet.name;
                    housePointsTitle.textContent = `Team Points: ${meet.name}`;
                    eventsTitle.textContent = `Events: ${meet.name}`;
                    showView('events');
                    fetchEvents(meet.id);
                });
                meetsGrid.appendChild(card);
            });
        }
        async function fetchMeets() {
            if (meetsUnsubscribe) meetsUnsubscribe();
            const meetsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets');
            meetsUnsubscribe = onSnapshot(query(meetsCol), snapshot => {
                const meets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMeets(meets);
                loadingEl.classList.add('hidden');
                mainContentEl.classList.remove('hidden');
                showView('meets');
            }, error => {
                console.error("Firestore Error fetching meets:", error);
                loadingMessage.innerHTML = '<strong>Error:</strong> Could not fetch data. Please verify your Firestore security rules.';
            });
        }
        addMeetForm.addEventListener('submit', (e) => {
             e.preventDefault();
             const formData = new FormData(e.target);
             const newMeet = { name: formData.get('meetName'), createdAt: new Date() };
             const meetsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets');
             addDoc(meetsCol, newMeet).then(() => {
                e.target.reset();
                addMeetModal.close();
             }).catch(err => console.error("Error adding meet:", err));
        });

        // --- EVENT FUNCTIONS ---
        function renderEvents(events) {
            eventsGrid.innerHTML = '';
            noEventsMessage.classList.toggle('hidden', events.length > 0);
            events.forEach(event => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-slate-800 p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer';
                card.innerHTML = `<h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 truncate">${event.name}</h3><p class="text-slate-500 dark:text-slate-400 capitalize">${event.scoringMethod === 'low-wins' ? 'Time-based' : 'Score-based'} Event</p>`;
                card.addEventListener('click', () => {
                    currentEventId = event.id;
                    currentEventName = event.name;
                    currentEvent = event;
                    currentSortOrder = 'placing'; // Reset sort order when viewing an event
                    resultsEventName.textContent = event.name;
                    let recordText = '';
                    if (event.record) {
                        const formattedRecord = isTimeBased(event.scoringMethod) ? formatTime(event.record) + 's' : event.record;
                        recordText = `Record: ${formattedRecord}${!isTimeBased(event.scoringMethod) ? event.units || '' : ''}`;
                        if (event.recordHolder) {
                            recordText += ` (${event.recordHolder}`;
                            if (event.recordYear) {
                                recordText += `, ${event.recordYear}`;
                            }
                            recordText += ')';
                        }
                    }
                    resultsEventInfo.textContent = `Results in ${event.units}. ${recordText}`;
                    showView('results');
                    fetchResults(currentMeetId, event.id, event);
                });
                eventsGrid.appendChild(card);
            });
        }
        async function fetchEvents(meetId) {
            calculateAndRenderHousePoints(meetId);
            if (eventsUnsubscribe) eventsUnsubscribe();
            const eventsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', meetId, 'events');
            eventsUnsubscribe = onSnapshot(query(eventsCol), snapshot => {
                const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEvents(events);
            }, error => {
                console.error("Firestore Error fetching events:", error);
            });
        }
        addEventForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(!currentMeetId) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events');
            const dataBuilder = fd => ({ 
                name: fd.get('eventName'), 
                scoringMethod: fd.get('scoringMethod'), 
                units: fd.get('eventUnits'),
                record: parseFloat(fd.get('eventRecord')) || null,
                recordHolder: fd.get('recordHolder') || null,
                recordYear: parseInt(fd.get('recordYear')) || null
            });
            handleFormSubmit(e, addEventModal, collectionRef, dataBuilder);
        });

        // --- PARTICIPANT/RESULT FUNCTIONS ---
        function renderParticipants(participants, event) {
            currentParticipants = participants; // Store for re-sorting
            const scoringMethod = event.scoringMethod;
            const eventRecord = event.record;
            
            const withResults = participants.filter(p => p.result !== null && p.result !== undefined);
            const withoutResults = participants.filter(p => p.result === null || p.result === undefined);
            
            withResults.sort((a, b) => isTimeBased(scoringMethod) ? a.result - b.result : b.result - a.result);
            
            if (withResults.length > 0) {
                 withResults.forEach(p => p.isRecord = false);
                const topResult = withResults[0].result;
                let isNewRecord = (eventRecord !== null && ((isTimeBased(scoringMethod) && topResult < eventRecord) || (!isTimeBased(scoringMethod) && topResult > eventRecord))) || (eventRecord === null && topResult !== null);
                if (isNewRecord) {
                    withResults.forEach(p => { if(p.result === topResult) p.isRecord = true; });
                }
                withResults[0].placing = 1;
                for (let i = 1; i < withResults.length; i++) {
                    if (withResults[i].result === withResults[i - 1].result) {
                        withResults[i].placing = withResults[i - 1].placing;
                    } else {
                        withResults[i].placing = i + 1;
                    }
                }
            }

            let displayList = [...withResults, ...withoutResults];

            if (currentSortOrder === 'alphabetical') {
                displayList.sort((a, b) => {
                    const surnameA = (a.athleteName.split(' ').pop() || '').toLowerCase();
                    const surnameB = (b.athleteName.split(' ').pop() || '').toLowerCase();
                    return surnameA.localeCompare(surnameB);
                });
            }

            resultsTableBody.innerHTML = '';
            const hasParticipants = participants.length > 0;
            noParticipantsMessage.classList.toggle('hidden', hasParticipants);
            resultsContainer.querySelector('table').classList.toggle('hidden', !hasParticipants);
            
            displayList.forEach(p => {
                const row = createParticipantRow(p, p.placing || '-', scoringMethod);
                resultsTableBody.appendChild(row);
            });
        }
        function createParticipantRow(participant, rank, scoringMethod) {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50';
            const hasResult = participant.result !== null && participant.result !== undefined;
            let displayResult = hasResult ? (isTimeBased(scoringMethod) ? formatTime(participant.result) : participant.result) : 'N/A';
            
            if (participant.isRecord) {
                displayResult += ` <span class="ml-2 text-amber-500 font-bold">üèÜ New Record!</span>`;
            }

            const houseColor = houseColors[participant.houseGroup] || { bg: 'bg-gray-200', text: 'text-gray-800' };
            const houseBadge = `<span class="px-2 py-1 text-xs font-semibold leading-tight rounded-full ${houseColor.bg} ${houseColor.text}">${participant.houseGroup}</span>`;
            
            const participationCheckbox = `
                <td class="p-3 text-center">
                    <input type="checkbox" data-id="${participant.id}" class="participation-check h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${participant.participated ? 'checked' : ''}>
                </td>
            `;

            row.innerHTML = `<td class="p-3 font-medium">${rank}</td><td class="p-3">${participant.athleteName}</td><td class="p-3">${houseBadge}</td>${participationCheckbox}<td class="p-3">${displayResult}</td><td class="p-3"></td>`;
            
            const actionsCell = row.cells[5];
            actionsCell.className = 'p-3 flex items-center gap-2';
            
            const resultButton = document.createElement('button');
            resultButton.textContent = hasResult ? 'Edit Result' : 'Add Result';
            resultButton.className = hasResult ? 'bg-yellow-500 text-white font-semibold px-3 py-1 text-sm rounded-md shadow hover:bg-yellow-600 transition' : 'bg-indigo-500 text-white font-semibold px-3 py-1 text-sm rounded-md shadow hover:bg-indigo-600 transition';
            resultButton.addEventListener('click', () => {
                editResultAthleteName.textContent = participant.athleteName;
                editResultParticipantId.value = participant.id;
                editResultForm.resultValue.value = participant.result || '';
                editResultModal.showModal();
            });
            actionsCell.appendChild(resultButton);

            const editButton = document.createElement('button');
            editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
            editButton.className = 'text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition';
            editButton.title = "Edit Participant";
            editButton.addEventListener('click', () => {
                editParticipantIdInput.value = participant.id;
                editAthleteNameInput.value = participant.athleteName;
                editHouseGroupSelect.value = participant.houseGroup;
                editParticipantModal.showModal();
            });
            actionsCell.appendChild(editButton);

            if (hasResult) {
                const clearButton = document.createElement('button');
                clearButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                clearButton.className = 'text-slate-500 hover:text-red-600 dark:hover:text-red-400 transition';
                clearButton.title = "Clear Result";
                clearButton.addEventListener('click', () => handleClearResult(participant.id));
                actionsCell.appendChild(clearButton);
            }

            row.querySelector('.participation-check').addEventListener('change', (e) => handleToggleParticipation(e.target.dataset.id, e.target.checked));

            return row;
        }
        async function fetchResults(meetId, eventId, event) {
            if (resultsUnsubscribe) resultsUnsubscribe();
            const resultsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', meetId, 'events', eventId, 'results');
            resultsUnsubscribe = onSnapshot(query(resultsCol), snapshot => {
                const participants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderParticipants(participants, event);
            }, error => console.error(`Error fetching results for event ${eventId}:`, error));
        }
        addParticipantForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(!currentMeetId || !currentEventId) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results');
            const dataBuilder = fd => ({ athleteName: fd.get('athleteName'), houseGroup: fd.get('houseGroup'), result: null, participated: false, createdAt: new Date() });
            handleFormSubmit(e, addParticipantModal, collectionRef, dataBuilder);
        });

        // --- GENERAL HANDLERS ---
        async function handleFormSubmit(e, modal, collectionRef, dataBuilder) {
            if(!collectionRef) return;
            try {
                await addDoc(collectionRef, dataBuilder(new FormData(e.target)));
                e.target.reset();
                modal.close();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }

        async function handleUpdateParticipant(e) {
            e.preventDefault();
            const participantId = editParticipantIdInput.value;
            const newName = editAthleteNameInput.value;
            const newHouse = editHouseGroupSelect.value;

            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { 
                    athleteName: newName,
                    houseGroup: newHouse
                });
                editParticipantForm.reset();
                editParticipantModal.close();
            } catch (error) {
                console.error("Error updating participant:", error);
            }
        }
        
        async function handleClearResult(participantId) {
            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { result: null });
            } catch (error) {
                console.error("Error clearing result:", error);
            }
        }

         async function handleToggleParticipation(participantId, isChecked) {
            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { participated: isChecked });
            } catch (error) {
                console.error("Error updating participation:", error);
            }
        }


        async function handleUpdateResult(e) {
            e.preventDefault();
            const participantId = editResultParticipantId.value;
            const resultValue = parseFloat(editResultForm.resultValue.value);
            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { result: resultValue, participated: true }); // Also mark as participated

                const eventDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId);
                const resultsColRef = collection(eventDocRef, 'results');
                const resultsSnapshot = await getDocs(resultsColRef);
                const participants = resultsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const withResults = participants.filter(p => p.result !== null && p.result !== undefined);
                
                if (withResults.length > 0) {
                    withResults.sort((a, b) => isTimeBased(currentEvent.scoringMethod) ? a.result - b.result : b.result - a.result);
                    const topResult = withResults[0].result;
                    const isNewRecord = (currentEvent.record && ((isTimeBased(currentEvent.scoringMethod) && topResult < currentEvent.record) || (!isTimeBased(currentEvent.scoringMethod) && topResult > currentEvent.record))) || (!currentEvent.record && topResult !== null);
                    
                    if (isNewRecord) {
                        const recordBreaker = withResults.find(p => p.result === topResult);
                        await updateDoc(eventDocRef, { 
                            record: topResult,
                            recordHolder: recordBreaker.athleteName,
                            recordYear: new Date().getFullYear()
                        });
                    }
                }

                editResultForm.reset();
                editResultModal.close();
            } catch (error) {
                console.error("Error updating result:", error);
            }
        }
        async function handleDeleteEvent() {
            if (!currentMeetId || !currentEventId) return;
            try {
                const eventDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId);
                const resultsColRef = collection(eventDocRef, 'results');
                const resultsSnapshot = await getDocs(resultsColRef);
                const batch = writeBatch(db);
                resultsSnapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
                await deleteDoc(eventDocRef);
                showView('events');
                currentEventId = null;
            } catch(error) {
                console.error("Error deleting event:", error);
            } finally {
                deleteConfirmModal.close();
            }
        }
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    parsedCsvData = results;
                    const headers = results.meta.fields;
                    [csvFirstNameSelect, csvSurnameSelect, csvHouseGroupSelect].forEach(sel => sel.innerHTML = '');
                    headers.forEach(header => {
                        [csvFirstNameSelect, csvSurnameSelect, csvHouseGroupSelect].forEach(sel => sel.add(new Option(header, header)));
                    });
                    const lowerCaseHeaders = headers.map(h => h.toLowerCase());
                    const firstNameIndex = lowerCaseHeaders.findIndex(h => h.includes('first') || h.includes('given'));
                    const surnameIndex = lowerCaseHeaders.findIndex(h => h.includes('last') || h.includes('surname'));
                    const houseIndex = lowerCaseHeaders.findIndex(h => h.includes('house'));
                    if (firstNameIndex > -1) csvFirstNameSelect.selectedIndex = firstNameIndex;
                    if (surnameIndex > -1) csvSurnameSelect.selectedIndex = surnameIndex;
                    if (houseIndex > -1) csvHouseGroupSelect.selectedIndex = houseIndex;
                    csvPreviewHead.innerHTML = `<tr>${headers.map(h => `<th class="p-2 font-semibold text-sm">${h}</th>`).join('')}</tr>`;
                    csvPreviewBody.innerHTML = results.data.slice(0, 5).map(row => `<tr class="border-t border-slate-200">${headers.map(h => `<td class="p-2 text-sm">${row[h] || ''}</td>`).join('')}</tr>`).join('');
                    csvUploadModal.showModal();
                },
                error: error => console.error("Error parsing CSV:", error)
            });
            csvFileInput.value = '';
        }
        async function handleConfirmCsvImport() {
            if (!parsedCsvData || !currentMeetId || !currentEventId) return;
            const firstNameColumn = csvFirstNameSelect.value;
            const surnameColumn = csvSurnameSelect.value;
            const houseColumn = csvHouseGroupSelect.value;
            
            if (!firstNameColumn || !surnameColumn || !houseColumn) {
                alert("Please map the First Name, Surname, and House Group columns.");
                return;
            }

            try {
                const batch = writeBatch(db);
                const resultsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results');
                parsedCsvData.data.forEach(row => {
                    const firstName = row[firstNameColumn];
                    const surname = row[surnameColumn];
                    const houseGroup = row[houseColumn];
                    if (firstName && surname && houseGroup) {
                        const athleteName = `${firstName.trim()} ${surname.trim()}`;
                        batch.set(doc(resultsCol), { athleteName: athleteName, houseGroup: houseGroup.trim(), result: null, participated: false, createdAt: new Date() });
                    }
                });
                await batch.commit();
                csvUploadModal.close();
                parsedCsvData = null;
            } catch (error) {
                console.error("Error importing participants:", error);
            }
        }
        async function calculateAndRenderHousePoints(meetId) {
            if(!meetId) return;
            const housePoints = { Mason: 0, Sheppard: 0, Sumner: 0, Taylor: 0 };
            const pointsMap = { 1: 5, 2: 3, 3: 1 };
            const participationPoint = 1;

            const eventsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'meets', meetId, 'events'));

            for (const eventDoc of eventsSnapshot.docs) {
                const event = eventDoc.data();
                const resultsSnapshot = await getDocs(collection(eventDoc.ref, 'results'));
                const participants = resultsSnapshot.docs.map(d => d.data());
                
                participants.forEach(p => {
                    if ((p.participated || (p.result !== null && p.result !== undefined)) && housePoints.hasOwnProperty(p.houseGroup)) {
                        housePoints[p.houseGroup] += participationPoint;
                    }
                });

                const withResults = participants.filter(p => p.result !== null && p.result !== undefined);
                if(withResults.length === 0) continue;

                withResults.sort((a, b) => isTimeBased(event.scoringMethod) ? a.result - b.result : b.result - a.result);
                
                if (withResults.length > 0) {
                    withResults[0].placing = 1;
                    for (let i = 1; i < withResults.length; i++) {
                        if (withResults[i].result === withResults[i - 1].result) {
                            withResults[i].placing = withResults[i - 1].placing;
                        } else {
                            withResults[i].placing = i + 1;
                        }
                    }
                }

                withResults.forEach(p => {
                    if (pointsMap[p.placing] && housePoints.hasOwnProperty(p.houseGroup)) {
                        housePoints[p.houseGroup] += pointsMap[p.placing];
                    }
                });
            }

            const sortedHouses = Object.entries(housePoints).sort((a, b) => b[1] - a[1]);
            housePointsList.innerHTML = sortedHouses.map(([name, score]) => {
                const houseColor = houseColors[name] || { bg: 'bg-gray-400', border: 'border-gray-400' };
                return `
                    <li class="flex justify-between items-center p-3 rounded-md border-l-4 ${houseColor.border} bg-slate-50 dark:bg-slate-700/50">
                        <div class="flex items-center">
                            <span class="font-semibold text-slate-800 dark:text-slate-200">${name}</span>
                        </div>
                        <span class="font-bold text-xl text-indigo-600 dark:text-indigo-400">${score}</span>
                    </li>
                `;
            }).join('');
        }
        
        // --- PDF Generation ---
        function generateResultsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Results for: ${currentEventName}`, 14, 16);
            doc.text(`Competition: ${currentMeetName}`, 14, 22);
            
            const tableData = [];
            const rows = resultsTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (index < 5) { 
                        if (index === 3) { // Participation column
                           rowData.push(cell.querySelector('input').checked ? 'Yes' : 'No');
                        } else {
                           rowData.push(cell.innerText);
                        }
                    }
                });
                tableData.push(rowData);
            });

            doc.autoTable({
                head: [['Placing', 'Participant Name', 'Team/House', 'Participated', 'Result']],
                body: tableData,
                startY: 30
            });
            doc.save(`results_${currentEventName.replace(/ /g, '_')}.pdf`);
        }
        
        function generateHousePointsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Team Points Summary`, 14, 16);
             doc.text(`Competition: ${currentMeetName}`, 14, 22);

            const tableData = [];
            const items = housePointsList.querySelectorAll('li');
            items.forEach(item => {
                const name = item.querySelector('span:first-child').innerText;
                const score = item.querySelector('span:last-child').innerText;
                tableData.push([name, score]);
            });

            doc.autoTable({
                head: [['Team/House', 'Total Points']],
                body: tableData,
                startY: 30
            });
            doc.save(`house_points_${currentMeetName.replace(/ /g, '_')}.pdf`);
        }
        
        // --- SIGN UP PAGE ---
        async function fetchAndRenderSignupPage(meetId) {
            loadingEl.classList.add('hidden');
            mainContentEl.classList.add('hidden');
            signupView.classList.remove('hidden');

            const meetDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', meetId);
            const meetDoc = await getDocs(meetDocRef);
            if(meetDoc.exists()) {
                const meetData = meetDoc.data();
                currentMeetName = meetData.name;
                signupCompetitionName.textContent = `Sign Up for: ${meetData.name}`;

                const eventsCol = collection(meetDocRef, 'events');
                const eventsSnapshot = await getDocs(eventsCol);
                const events = eventsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderSignupEvents(events);

            } else {
                 noSignupEventsMessage.classList.remove('hidden');
            }
        }
        
        function renderSignupEvents(events) {
            signupEventsGrid.innerHTML = '';
            noSignupEventsMessage.classList.toggle('hidden', events.length > 0);
            events.forEach(event => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-slate-800 p-5 rounded-lg shadow-md';
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 truncate">${event.name}</h3>
                    <p class="text-slate-500 dark:text-slate-400 capitalize">${event.scoringMethod === 'low-wins' ? 'Time-based' : 'Score-based'} Event</p>
                    <button data-event-id="${event.id}" data-event-name="${event.name}" class="signup-btn mt-4 w-full bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-teal-700 transition duration-200">Sign Up</button>
                `;
                signupEventsGrid.appendChild(card);
            });

            document.querySelectorAll('.signup-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    signupEventName.textContent = `Sign Up for: ${btn.dataset.eventName}`;
                    signupEventIdInput.value = btn.dataset.eventId;
                    signupFormContainer.classList.remove('hidden');
                    signupMessageContainer.classList.add('hidden');
                    publicSignupForm.reset();
                    publicSignupModal.showModal();
                });
            });
        }
        
        async function handlePublicSignup(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const eventId = formData.get('eventId');
            const participantName = formData.get('signupName').trim();
            const houseGroup = formData.get('signupHouse');
            
            const resultsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', eventId, 'results');
            
            // Check for duplicates
            const q = query(resultsCol, where("athleteName", "==", participantName));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                signupMessage.textContent = 'You are already signed up for this event.';
            } else {
                await addDoc(resultsCol, {
                    athleteName: participantName,
                    houseGroup: houseGroup,
                    result: null,
                    participated: false,
                    createdAt: new Date()
                });
                signupMessage.textContent = 'Successfully signed up!';
            }
            signupFormContainer.classList.add('hidden');
            signupMessageContainer.classList.remove('hidden');
        }


        // --- NAVIGATION AND INIT ---
        addMeetBtn.addEventListener('click', () => addMeetModal.showModal());
        addEventBtn.addEventListener('click', () => addEventModal.showModal());
        addParticipantBtn.addEventListener('click', () => addParticipantModal.showModal());
        editResultForm.addEventListener('submit', handleUpdateResult);
        editParticipantForm.addEventListener('submit', handleUpdateParticipant);
        publicSignupForm.addEventListener('submit', handlePublicSignup);
        
        backToMeetsBtn.addEventListener('click', () => {
             if (eventsUnsubscribe) { eventsUnsubscribe(); eventsUnsubscribe = null; }
            currentMeetId = null;
            showView('meets');
        });
        backToEventsBtn.addEventListener('click', async () => {
            if (resultsUnsubscribe) { resultsUnsubscribe(); resultsUnsubscribe = null; }
            currentEventId = null;
            showView('events');
            await calculateAndRenderHousePoints(currentMeetId);
        });

        shareLinkBtn.addEventListener('click', () => {
            const url = `${window.location.origin}${window.location.pathname}?signup=${currentMeetId}`;
            shareableLinkInput.value = url;
            shareLinkModal.showModal();
        });

        copyLinkBtn.addEventListener('click', () => {
            shareableLinkInput.select();
            document.execCommand('copy');
            copyLinkBtn.textContent = 'Copied!';
            setTimeout(() => { copyLinkBtn.textContent = 'Copy Link'; }, 2000);
        });


        deleteEventBtn.addEventListener('click', () => {
            deleteConfirmText.textContent = `This will permanently delete the event "${currentEventName}" and all its results. This action cannot be undone.`
            deleteConfirmModal.showModal();
        });
        confirmDeleteBtn.addEventListener('click', handleDeleteEvent);
        uploadCsvBtn.addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', handleFileSelect);
        confirmCsvImport.addEventListener('click', handleConfirmCsvImport);
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('dialog').close()));
        
        printHousePointsBtn.addEventListener('click', generateHousePointsPdf);
        printResultsBtn.addEventListener('click', generateResultsPdf);
        
        sortByNameBtn.addEventListener('click', () => {
            currentSortOrder = currentSortOrder === 'placing' ? 'alphabetical' : 'placing';
            renderParticipants(currentParticipants, currentEvent);
        });

        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            themeToggle.checked = true;
        }
        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        });

        function enablePrintButtons() {
            printHousePointsBtn.disabled = false;
            printHousePointsBtn.textContent = 'Print Points';
            printResultsBtn.disabled = false;
            printResultsBtn.textContent = 'Print Results';
        }

        async function init() {
            console.log("BIDD SPORTS Initializing...");
            const urlParams = new URLSearchParams(window.location.search);
            const signupMeetId = urlParams.get('signup');

            const pdfLibraryCheck = setInterval(() => {
                if (window.pdfLibrariesLoaded) {
                    enablePrintButtons();
                    clearInterval(pdfLibraryCheck);
                }
            }, 100);

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                loadingMessage.innerHTML = '<strong>Configuration Incomplete.</strong><br>Firebase config is missing from the HTML file.';
                loadingEl.querySelector('.loader').classList.add('hidden');
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (signupMeetId) {
                            currentMeetId = signupMeetId;
                            await fetchAndRenderSignupPage(signupMeetId);
                        } else {
                            await fetchMeets();
                        }
                    } else {
                        signInAnonymously(auth).catch((error) => {
                             console.error("Anonymous sign-in failed:", error);
                             loadingMessage.textContent = 'Error: Could not authenticate. Please check your connection and browser settings.';
                             loadingEl.querySelector('.loader').classList.add('hidden');
                        });
                    }
                });

                await enableIndexedDbPersistence(db).catch(err => console.warn("Offline persistence not available:", err.code));
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingMessage.textContent = 'Error: Could not connect to the database. Check console for details.';
                loadingEl.querySelector('.loader').classList.add('hidden');
            }
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(reg => {
                    console.log('Service worker registered successfully:', reg);
                }).catch(err => {
                    console.log('Service worker registration failed: ', err);
                });
            });
        }

        init();
    </script>
</body>
</html>

